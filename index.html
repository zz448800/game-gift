<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤§è±¬2025å¹´æœ«æœ‰çå¾µç­”ï¼</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* è¨­å®šå­—é«”ç‚º Inter */
        body {
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
        }

        /* æ…¶ç¥èƒŒæ™¯åœ–æ¡ˆ (ä½¿ç”¨ä½¿ç”¨è€…æä¾›çš„åœ–ç‰‡) */
        /* ã€è·¯å¾‘ä¿®æ­£ï¼šä½¿ç”¨æ­£ç¢ºçš„ assets-gift è³‡æ–™å¤¾è·¯å¾‘ã€‘ */
        .celebration-bg {
            background-image: url('./assets-gift/birthday_background.jpg'); 
            background-size: cover;
            background-position: center center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            background-color: #BEE3F8;
        }

        /* è‡ªå®šç¾©å‹•ç•«ï¼šç•¥ */
        @keyframes jiggle {
            0%, 100% { transform: scale(1) rotate(0deg); }
            25% { transform: scale(1.05) rotate(2deg); }
            75% { transform: scale(1.05) rotate(-2deg); }
        }

        @keyframes openAndGlow {
            0% { transform: scale(1); opacity: 1; box-shadow: 0 0 10px rgba(255, 255, 255, 0.5); }
            50% { transform: scale(1.1); opacity: 1; box-shadow: 0 0 40px rgba(255, 255, 0, 0.8); }
            100% { transform: scale(1); opacity: 0; }
        }

        @keyframes explosion {
            0% { transform: scale(1) rotate(0deg); opacity: 1; }
            100% { transform: scale(2) rotate(30deg); opacity: 0; } 
        }

        @keyframes strongGlow {
            0% { box-shadow: 0 0 0 rgba(255, 255, 255, 0); }
            50% { box-shadow: 0 0 80px 30px rgba(255, 255, 100, 1); }
            100% { box-shadow: 0 0 0 rgba(255, 255, 255, 0); }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .typewriter-text {
            border-right: .15em solid #FCD34D;
            white-space: pre-wrap;
            overflow: hidden;
        }

        .hidden-item {
            display: none;
        }

        .gift-media {
            max-width: 90%;
            height: auto;
            border-radius: 1.5rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s ease-in-out;
            margin-bottom: 1rem;
        }
        video.gift-media {
            width: 100%;
            max-height: 50vh;
            object-fit: cover;
        }

        .piggy-button {
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            font-weight: bold;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .piggy-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }

        .quiz-option {
            display: flex;
            align-items: flex-start; /* è®“å¤šè¡Œæ–‡å­—ä¹Ÿèƒ½å°é½Š */
            padding: 0.5rem 1rem;
            margin-bottom: 0.5rem;
            border-radius: 0.75rem;
            background-color: #FFFBEB;
            cursor: pointer;
            transition: background-color 0.2s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        .quiz-option:hover {
            background-color: #FCD34D;
        }
        .quiz-option input[type="radio"],
        .quiz-option input[type="checkbox"] {
            margin-right: 1rem;
            margin-top: 0.25rem; /* è®“ Checkbox/Radio ç¨å¾®ä¸‹ç§» */
            flex-shrink: 0; /* é˜²æ­¢ç¸®å° */
            transform: scale(1.5);
            accent-color: #F59E0B;
        }
        .text-cute-shadow {
             text-shadow: 2px 2px 0px #FCD34D;
             color: #D97706;
        }
        /* æ–°å¢ï¼šå•ç­”éŒ¯èª¤å›é¥‹çš„æ¨£å¼ */
        .feedback-message {
            margin-top: 1rem;
            padding: 0.75rem 1.5rem;
            background-color: #FEE2E2; /* Red 100 */
            color: #B91C1C; /* Red 700 */
            border: 2px solid #F87171; /* Red 400 */
            border-radius: 0.75rem;
            font-weight: bold;
            animation: fadeIn 0.5s ease-out;
        }

        /* è¼ªæ’­åœ–æ¨£å¼ */
        .slideshow-img {
            max-height: 40vh;
            width: auto;
            max-width: 100%;
            object-fit: contain;
            border-radius: 1.5rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            transition: opacity 1s ease-in-out, transform 0.5s ease-in-out;
            opacity: 0;
            transform: scale(0.95);
        }
        .slideshow-img.active {
            opacity: 1;
            transform: scale(1);
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center p-4 celebration-bg">
    
    <!-- 1. èƒŒæ™¯éŸ³æ¨‚æ’­æ”¾å™¨ (éš±è—) -->
    <!-- æ ¹æ“šä½¿ç”¨è€…éœ€æ±‚ï¼Œä½¿ç”¨ä¸Šå‚³çš„éŸ³æ¨‚æª”æ¡ˆä¸¦è¨­å®š loop -->
    <audio id="background-music" loop>
        <!-- ä½¿ç”¨ä¸Šå‚³çš„ music.mp3 æª”æ¡ˆ -->
        <source src="http://googleusercontent.com/file_content/1" type="audio/mpeg">
        ä½ çš„ç€è¦½å™¨ä¸æ”¯æ´éŸ³è¨Šæ’­æ”¾ã€‚
    </audio>

    <!-- ä¸»éŠæˆ²å®¹å™¨ -->
    <div id="game-container" class="w-full max-w-lg bg-white/95 backdrop-blur-sm p-8 md:p-10 rounded-3xl shadow-2xl text-center min-h-[500px] flex flex-col justify-center items-center" 
         style="background-color: rgba(255, 255, 255, 0.98); border: 4px solid #FCD34D;">
        
        <!-- å…§å®¹é¡¯ç¤ºå€åŸŸ -->
        <div id="content-display" class="flex flex-col items-center justify-center w-full h-full space-y-6">
            <!-- éŠæˆ²å…§å®¹/å•ç­”/ç¦®ç‰©æœƒé¡¯ç¤ºåœ¨é€™è£¡ -->
        </div>

        <!-- ç¦®ç‰©ç›’å…ƒç´  (ç”¨æ–¼å‹•ç•«å’Œé»æ“Š) -->
        <!-- ã€è·¯å¾‘ä¿®æ­£ï¼šä½¿ç”¨æ­£ç¢ºçš„ assets-gift è³‡æ–™å¤¾è·¯å¾‘ã€‘ -->
        <img id="gift-box-visual" 
             src="./assets-gift/gift1.jpg" 
             alt="ç”Ÿæ—¥ç¦®ç‰©ç›’" 
             class="cursor-pointer w-48 h-48 md:w-64 md:h-64 object-contain transition-all duration-300 hidden-item" 
             onclick="handleGiftClick()">

        <!-- å‹•ä½œæŒ‰éˆ• -->
        <div id="action-area" class="mt-8">
            <!-- æŒ‰éˆ•å€ -->
        </div>

        <!-- éŒ¯èª¤è¨Šæ¯/åŠ è¼‰æŒ‡ç¤º (æ­¤è™•ä¸»è¦ç”¨æ–¼è‡¨æ™‚ç‹€æ…‹é¡¯ç¤º) -->
        <p id="message" class="mt-4 text-red-500 font-semibold"></p>
        <div id="loading-spinner" class="hidden-item">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-amber-500"></div>
            <p class="text-amber-600 mt-2">å°è±¬æ­£åœ¨æº–å‚™ç‰¹åˆ¥ç¦®ç‰©...</p>
        </div>

    </div>

    <script>
        // === éŠæˆ²ç‹€æ…‹å®šç¾© ===
        let gameState = 0;
        let currentGiftIndex = 0;
        let slideshowIndex = 0;
        let slideshowInterval = null; // ç”¨æ–¼å„²å­˜è¼ªæ’­è¨ˆæ™‚å™¨

        // --- ç‹€æ…‹ç¢¼å®šç¾© ---
        const STATE = {
            INTRO: 0,
            QUIZ_START: 1, // Q1
            QUIZ_END: 10,  // Q10
            CONFIRM_Q9: 11, // Q9 å¤±æ•—ç¢ºèªç•«é¢ (ä½ çœŸçš„ä¸æ„›å°è±¬å—?)
            CONFIRM_Q10: 12, // Q10 å¤±æ•—ç¢ºèªç•«é¢ (æ‰€ä»¥ä½ ä¸æ„›å°è±¬å—?)
            CONGRATS: 13, // æ­å–œç•«é¢
            GIFT_PREP: 14, // ç¦®ç‰©ç›’ç­‰å¾…é»æ“Š
            GIFT_REVEAL_START: 15, // ç¦®ç‰© 1
            GIFT_EXPLOSION: 20, // çˆ†ç‚¸ç¦®ç‰©
            GIFT_FINAL: 21, // æœ€çµ‚å¤§ç
            CARD: 22, // æœ€çµ‚å¡ç‰‡
            PHOTO_SLIDESHOW: 23 // æ–°å¢ï¼šåˆç…§è¼ªæ’­
        };
        
        const contentDisplay = document.getElementById('content-display');
        const giftBoxVisual = document.getElementById('gift-box-visual');
        const actionArea = document.getElementById('action-area');
        const message = document.getElementById('message');
        const loadingSpinner = document.getElementById('loading-spinner');
        const backgroundMusic = document.getElementById('background-music');

        let musicPlayed = false; // æ–°å¢ï¼šè¿½è¹¤æ˜¯å¦å·²å˜—è©¦æ’­æ”¾éŸ³æ¨‚ä¸¦é¡¯ç¤ºæç¤º

        // å®šç¾©å•ç­”é¡Œç›® (State 1 åˆ° State 10)
        // ... (å•é¡Œå®šç¾©ä¿æŒä¸è®Šï¼Œç•¥) ...
        const questions = [
            // Q1: State 1 (Index 0)
            { 
                state: 1, 
                title: "è«‹å•ä½ æ˜¯?", 
                type: 'single',
                options: [
                    { text: "å°è±¬å°ˆå±¬ç§˜æ›¸ å¤§è±¬", isCorrect: true },
                    { text: "è”¡å³æé¾", isCorrect: false, feedback: 'å†æƒ³æƒ³çœ‹ï¼Œä½ æ˜¯èª°ï¼Ÿ' },
                    { text: "è¶…ç´šå¤§å¸¥å“¥", isCorrect: false, feedback: 'é›–ç„¶ä½ æ˜¯ï¼Œä½†æœ‰æ›´é‡è¦çš„èº«ä»½ï¼' },
                ],
                successState: 2
            },
            // Q2: State 2 (Index 1)
            { 
                state: 2, 
                title: "å°è±¬æ˜¯èª°", 
                type: 'single',
                options: [
                    { text: "èƒ–èƒ–åœ“åœ“å°è±¬", isCorrect: false, feedback: 'ä½ æ‰åœ“åœ“èƒ–èƒ–!!!' },
                    { text: "æœ€å¯æ„›æ¼‚äº®çš„å¥³æœ‹æœ‹è±¬è±¬æœƒç¤¾ç¸½è£", isCorrect: true },
                    { text: "æˆ‘ä¸èªè­˜å°è±¬ï¼Œä»–èª°?", isCorrect: false, feedback: 'æˆ‘å†çµ¦ä½ ä¸€æ¬¡å°éšä¸‹' },
                ],
                successState: 3
            },
            // Q3: State 3 (Index 2)
            { 
                state: 3, 
                title: "å°è±¬æœ€å®³æ€•ç”šéº¼", 
                type: 'single',
                options: [
                    { text: "èŸ‘è‚", isCorrect: false, feedback: 'é›–ç„¶çœŸçš„è¶…æ€•' },
                    { text: "è®Šå¥½èƒ–èƒ–èƒ–èƒ–èƒ–èƒ–", isCorrect: false, feedback: 'é›–ç„¶è¶…å®³æ€•' },
                    { text: "å¤§è±¬ä¸æ„›å°è±¬äº†", isCorrect: true },
                ],
                successState: 4
            },
            // Q4: State 4 (Index 3)
            { 
                state: 4, 
                title: "å°è±¬ç—›ç—› ä¸èˆ’æœçš„æ™‚å€™è©²æ€éº¼è¾¦", 
                type: 'single',
                options: [
                    { text: "ç°¡å–®èªªå¹«ä½ å‘¼å‘¼ä¹–ä¹–å¾Œç¹¼çºŒåšè‡ªå·±çš„äº‹", isCorrect: false, feedback: 'å¤ªæ•·è¡äº†æ ¹æœ¬æ²’æœ‰ç”¨å•¦' },
                    { text: "æ‘¸æ‘¸å°è±¬çš„é ­ æŠ±è‘—é™ªåœ¨å°è±¬èº«é‚Š ç…§é¡§å¥¹", isCorrect: true },
                    { text: "å°è±¬å¾ˆå …å¼·ä»–è‡ªå·±å¯ä»¥æ’éå»ä¸ç”¨æˆ‘åœ¨", isCorrect: false, feedback: 'é‚£å°è±¬å°±ä¸éœ€è¦ä½ äº†æ‹‰' },
                ],
                successState: 5
            },
            // Q5: State 5 (Index 4)
            { 
                state: 5, 
                title: "å°è±¬ç”Ÿæ°£çš„æ™‚å€™æ€éº¼è¾¦", 
                type: 'single',
                options: [
                    { text: "ç¹¼çºŒæƒ¹å°è±¬ç”Ÿæ°£ è‡ªå·±å¤§ç¬‘å“ˆå“ˆå“ˆå“ˆå“ˆ", isCorrect: false, feedback: 'å°è±¬æ€’ç«ä¸­ç‡’' },
                    { text: "ä¸ç†å°è±¬ç­‰å¥¹æ°£æ¶ˆå†èªª", isCorrect: false, feedback: 'é‚£å°è±¬æ°¸é ä¸ç†ä½ äº†' },
                    { text: "å¦‚æœè‡ªå·±åšéŒ¯é“æ­‰è¨˜ä½ä¸è¦å†çŠ¯ å“„å“„å°è±¬è®“ä»–é–‹å¿ƒ", isCorrect: true },
                ],
                successState: 6
            },
            // Q6: State 6 (Index 5)
            { 
                state: 6, 
                title: "å°è±¬ç”šéº¼æ™‚å€™æœ€é–‹å¿ƒ", 
                type: 'single',
                options: [
                    { text: "åƒåˆ°å¥½åƒæ±è¥¿çš„æ™‚å€™", isCorrect: false, feedback: 'é›–ç„¶ä¹Ÿæ˜¯å¾ˆé–‹å¿ƒ' },
                    { text: "è¦‹åˆ°å¤§è±¬çš„æ™‚å€™", isCorrect: true },
                    { text: "åš•åˆ°è²“å’ªçš„æ™‚å€™", isCorrect: false, feedback: 'é›–ç„¶ä¹Ÿæ˜¯è¶…é–‹å¿ƒ' },
                ],
                successState: 7
            },
            // Q7: State 7 (Index 6) - è¤‡é¸é¡Œ
            { 
                state: 7, 
                title: "å°è±¬æœ€æƒ³è¦ç”šéº¼ç¦®ç‰©(è¤‡é¸é¡Œ)", 
                type: 'multi',
                options: [
                    { text: "å¤§è±¬è¦ªæ‰‹åšå¡ç‰‡", isCorrect: true },
                    { text: "æ¼‚äº®èŠ±èŠ±", isCorrect: true },
                    { text: "é …éŠ", isCorrect: true },
                    { text: "å°å°è±¬èªªæ„Ÿäººæ„Ÿæ€§çš„è©±", isCorrect: true },
                    { text: "æº«æŸ”çš„å°å°è±¬ æŠ±æŠ±å°è±¬ å¸¶å°è±¬å‡ºå»ç©", isCorrect: true },
                    { text: "ä¸€ç›´é™ªåœ¨å°è±¬èº«é‚Šä¸è®“å¥¹å­¤å–®é›£é", isCorrect: true },
                    { text: "é€—å°è±¬é–‹å¿ƒ", isCorrect: true },
                ],
                successState: 8,
                failureFeedback: 'å¥½åƒé‚„æœ‰å…¶ä»–æ±è¥¿?'
            },
            // Q8: State 8 (Index 7) - è¤‡é¸é¡Œ
            { 
                state: 8, 
                title: "å°è±¬æœ€è¨å­ç”šéº¼(è¤‡é¸é¡Œ)", 
                type: 'multi',
                options: [
                    { text: "èªªè¬Šæ¬ºé¨™", isCorrect: true },
                    { text: "ç¹¼çºŒæƒ¹å°è±¬ç”Ÿæ°£", isCorrect: true },
                    { text: "ä¸ç†å°è±¬ å¿½è¦–å°è±¬ è·Ÿæœ‹å‹å‡ºå»å¿˜è¨˜å°è±¬", isCorrect: true },
                    { text: "å¿˜è¨˜èªªéçš„æ‰¿è«¾", isCorrect: true },
                    { text: "é‡è¤‡çŠ¯ä»¥å‰çŠ¯éçš„éŒ¯", isCorrect: true },
                    { text: "å°å°è±¬ä¸è€ç…© æ²’è€æ€§", isCorrect: true },
                    { text: "å…‡å°è±¬", isCorrect: true },
                ],
                successState: 9,
                failureFeedback: 'ä½ ç¢ºå®šåªæœ‰é€™äº›?'
            },
            // Q9: State 9 (Index 8) - Branching Q (åŸ Q2)
            { 
                state: 9, 
                title: "ä½ æœ€æ„›çš„äººæ˜¯?", 
                type: 'branching',
                options: [
                    { text: "å°è±¬ç¸½è£", isCorrect: true }, // Success -> State 10
                    { text: "IU", isCorrect: false, feedback: 'ä½ ç¢ºå®šå—' }, // Incorrect, stay on Q9
                    { text: "æˆ‘æ²’æœ‰æœ€æ„›çš„äºº æˆ‘æ²’æœ‰æ„›å°è±¬", isCorrect: false, failureState: STATE.CONFIRM_Q9 }, // Branch to Confirmation Screen (State 11)
                ],
                successState: 10
            },
            // Q10: State 10 (Index 9) - Branching Q (åŸ Q3)
            { 
                state: 10, 
                title: "ä½ é¡˜æ„å°å°è±¬å¥½ï¼Œå¿ èª ä¸æ¬ºé¨™ä¸éš±çï¼ŒçœŸå¿ƒçš„æ„›å°è±¬å—", 
                type: 'branching',
                options: [
                    { text: "æˆ‘é¡˜æ„", isCorrect: true }, // Success -> State 13 (GongXi)
                    { text: "æˆ‘ä¸é¡˜æ„", isCorrect: false, failureState: STATE.CONFIRM_Q10 }, // Branch to Confirmation Screen (State 12)
                ],
                successState: STATE.CONGRATS // æˆåŠŸè·³åˆ°æ­å–œç•«é¢
            }
        ];

        // ç¦®ç‰©åºåˆ— (å°æ‡‰ç‹€æ…‹ 15 åˆ° 21)
        // ã€è·¯å¾‘ä¿®æ­£ï¼šä½¿ç”¨æ­£ç¢ºçš„ assets-gift è³‡æ–™å¤¾è·¯å¾‘ã€‘
        const giftSequence = [
            { id: 1, img: "./assets-gift/placeholder_pig.jpg", title: "æ­å–œä½ ç²å¾—!", text: "çµ‚èº«ã„…ã„§ã„¤Ë‹ã„…ã„§ã„¤Ë‹è±¬è±¬ç(è¶…ã„…ã„§ã„¤Ë‹!)", nextBtnText: "æ‰“é–‹ä¸‹ä¸€å€‹ç¦®ç‰©ç›’", nextState: STATE.GIFT_PREP },
            { id: 2, img: "./assets-gift/gift2.jpg", title: "æ­å–œä½ ç²å¾—!", text: "ç”Ÿæ—¥è›‹ç³•å…Œæ›å·(å£å‘³ä»»é¸)", nextBtnText: "æ‰“é–‹ä¸‹ä¸€å€‹ç¦®ç‰©ç›’", nextState: STATE.GIFT_PREP },
            { id: 3, img: "./assets-gift/gift3.jpg", title: "æ­å–œä½ ç²å¾—!", text: "ä¿æš–å¥—è£ (è¨˜å¾—å‘Šè¨´å°è±¬ä½ å–œæ­¡çš„é¡è‰²å–”)", nextBtnText: "æ‰“é–‹ä¸‹ä¸€å€‹ç¦®ç‰©ç›’", nextState: STATE.GIFT_PREP },
            { id: 4, img: "./assets-gift/gift4.jpg", title: "æ­å–œä½ ç²å¾—!", text: "å¯æ„›å¥³å‹å‡ºé“ç…§ä¸€å¼µ(å¯¦é«”ç°½åç…§)", nextBtnText: "æ‰“é–‹ä¸‹ä¸€å€‹ç¦®ç‰©ç›’", nextState: STATE.GIFT_PREP },
            { id: 5, img: "./assets-gift/my_birthday_video.mp4", title: "æ­å–œä½ ç²å¾—!", text: "å°è±¬å”±çµ¦ä½ è½", nextBtnText: "æ‰“é–‹ä¸‹ä¸€å€‹ç¦®ç‰©ç›’", nextState: STATE.GIFT_PREP },
            { id: 6, img: "./assets-gift/placeholder_explosion.jpg", title: "ğŸ’¥ ç¦®ç‰©çˆ†ç‚¸! ğŸ’¥", text: "éŠ˜è¬æƒ é¡§å“ˆå“ˆï¼Œå†é–‹ä¸€æ¬¡", nextBtnText: "å†é–‹ä¸€æ¬¡ï¼", isExplosion: true },
            { id: 7, img: "./assets-gift/gift5.jpg", title: "é€™æ˜¯â€¦.!!!!!!!!!", text: "æ­å–œä½ ç²å¾—æœ€å¤§ç: DJI pocket3ä¸€å¥—\n\nä½ å¸¶å°è±¬ç‘å£«è¡Œï¼Œå°è±¬å¹«ä½ å…¨éƒ¨è¨˜éŒ„èµ·ä¾†", nextBtnText: "ä½ å–œæ­¡é€™äº›ç¦®ç‰©å—?", nextState: STATE.CARD },
        ];

        // å¡ç‰‡å…§å®¹ (ä¸è®Š)
        const cardText = `çµ¦å¤§è±¬:

æœ‰æ²’æœ‰å–œæ­¡æˆ‘çš„é©šå–œå‘€ï¼Œé€™æ˜¯æˆ‘å¹«ä½ æ…¶ç¥çš„ç¬¬äºŒå€‹ç”Ÿæ—¥ï¼Œæ™‚é–“éå¾—å¥½å¿«ï¼Œé›–ç„¶åˆæ˜¯ä¸èƒ½é™ªåœ¨ä½ èº«é‚Šçš„ä¸€å¹´ï¼Œä½†é‚„æ˜¯å¸Œæœ›èƒ½è®“ä½ æ„Ÿè¦ºé–‹å¿ƒã€‚ä½ å¹«æˆ‘å‡ºæ©Ÿç¥¨æˆ‘è²·ç›¸æ©Ÿçµ¦ä½ ï¼Œè¦è¨˜éŒ„æˆ‘å€‘ä¸€èµ·å»å¥½å¤šå¥½å¤šåœ°æ–¹ç©ï¼Œè¦å»ç’°éŠå…¨ä¸–ç•Œ!
è¬è¬ä½ åœ¨æˆ‘éœ€è¦çš„æ™‚å€™é™ªåœ¨æˆ‘èº«é‚Šï¼Œçµ¦æˆ‘å»ºè­°è½æˆ‘ç™¼æ´©ï¼Œé›–ç„¶æœ‰æ™‚å€™ç£¨åˆã€æƒ³æ³•å¯èƒ½ä¸ä¸€æ¨£ï¼Œä½†æˆ‘å€‘è¦è¶Šä¾†è¶Šå¥½å•¦ï¼Œå¸Œæœ›æˆ‘å€‘èƒ½æˆç‚ºå½¼æ­¤äº’è£œæœ€ä½³æ‹æª”
26æ­²äº†ç”Ÿæ—¥å¿«æ¨‚è¦æ›´æ„›å°è±¬ã€å°å°è±¬æ›´å¥½å–”ï¼Œæˆ‘æ„›ä½  ğŸ’`;

        // è¼ªæ’­ç…§ç‰‡æ¸…å–®
        // è«‹å°‡ä»¥ä¸‹ URL æ›¿æ›æˆæ‚¨å¯¦éš›çš„ç…§ç‰‡è·¯å¾‘ï¼
        const slideshowPhotos = [
            "https://placehold.co/600x400/FFD1DC/663399?text=ç…§ç‰‡1+å¯æ„›åˆç…§",
            "https://placehold.co/600x400/99CCFF/333366?text=ç…§ç‰‡2+æ—…è¡Œå›æ†¶",
            "https://placehold.co/600x400/CCFFCC/336633?text=ç…§ç‰‡3+ç¾é£Ÿæ™‚å…‰",
            "https://placehold.co/600x400/FF9999/660000?text=ç…§ç‰‡4+æœ€æ„›å¤§è±¬",
        ];

        // === è¼”åŠ©å‡½æ•¸ (éŸ³æ¨‚æ§åˆ¶å·²æ›´æ–°) ===

        /**
         * åœæ­¢èƒŒæ™¯éŸ³æ¨‚
         */
        function stopMusic() {
            if (backgroundMusic) {
                backgroundMusic.pause();
                backgroundMusic.currentTime = 0;
            }
        }
        
        /**
         * å˜—è©¦æ’­æ”¾èƒŒæ™¯éŸ³æ¨‚
         */
        function playMusic() {
            if (backgroundMusic && backgroundMusic.paused) {
                backgroundMusic.play().catch(error => {
                    if (!musicPlayed) {
                        // å¦‚æœè‡ªå‹•æ’­æ”¾å¤±æ•—ï¼Œé¡¯ç¤ºä¸€æ¬¡æç¤º
                        message.textContent = 'ğŸ”Š è«‹é»æ“Šé€™è£¡æˆ–ç•«é¢ä»»æ„è™•ä»¥æ’­æ”¾èƒŒæ™¯éŸ³æ¨‚ï¼';
                        message.classList.remove('text-red-500', 'font-semibold');
                        message.classList.add('text-amber-600', 'font-bold', 'cursor-pointer');
                        message.onclick = () => {
                            backgroundMusic.play();
                            message.textContent = 'ğŸ¶ èƒŒæ™¯éŸ³æ¨‚å·²å•Ÿå‹•ï¼';
                            message.classList.remove('cursor-pointer');
                            message.onclick = null;
                        };
                        musicPlayed = true; // æ¨™è¨˜å·²æç¤º
                    }
                });
            }
        }
        
        /**
         * é¡¯ç¤ºå…§å®¹å¡ç‰‡ (é€šç”¨æ–¼ä»‹ç´¹ã€ç¦®ç‰©å…§å®¹ã€ç¢ºèªç•«é¢)
         */
        function showContentCard(title, bodyHtml, mediaUrl = null, stateClass = 'bg-amber-50/80') {
            // åœ¨åˆ‡æ›ç‹€æ…‹æ™‚ï¼Œåœæ­¢è¼ªæ’­ (ä½†**ä¸**åœæ­¢éŸ³æ¨‚ï¼ŒéŸ³æ¨‚ç”± updateGame çµ±ä¸€æ§åˆ¶)
            clearInterval(slideshowInterval);

            let mediaHtml = '';
            if (mediaUrl) {
                const isVideo = mediaUrl.toLowerCase().endsWith('.mp4') || mediaUrl.toLowerCase().endsWith('.mov');
                
                if (isVideo) {
                    // å½±ç‰‡è¼‰å…¥å¤±æ•—æ™‚çš„éŒ¯èª¤æç¤º (æ–°å¢ Console åµéŒ¯)
                    mediaHtml = `<video src="${mediaUrl}" controls loop autoplay muted class="gift-media mb-4 mx-auto" 
                        onerror="this.onerror=null; this.src='https://placehold.co/400x300/FFFBEB/D97706?text=å½±ç‰‡è¼‰å…¥å¤±æ•—%0Aè«‹æª¢æŸ¥æª”æ¡ˆåç¨±'; console.error('ã€åµéŒ¯ã€‘å½±ç‰‡è¼‰å…¥å¤±æ•—ï¼Œå˜—è©¦çš„ç¶²å€æ˜¯: ' + this.src);" 
                        alt="é©šå–œå½±ç‰‡"></video>`;
                } else {
                    // åœ–ç‰‡è¼‰å…¥å¤±æ•—æ™‚çš„éŒ¯èª¤æç¤º (æ–°å¢ Console åµéŒ¯)
                    mediaHtml = `<img src="${mediaUrl}" class="gift-media mx-auto" alt="å…§å®¹åœ–ç‰‡" 
                        onerror="this.onerror=null; this.src='https://placehold.co/400x300/FFFBEB/D97706?text=åœ–ç‰‡è¼‰å…¥å¤±æ•—%0Aè«‹æª¢æŸ¥æª”æ¡ˆåç¨±'; console.error('ã€åµéŒ¯ã€‘åœ–ç‰‡è¼‰å…¥å¤±æ•—ï¼Œå˜—è©¦çš„ç¶²å€æ˜¯: ' + this.src);">`;
                }
            }

            contentDisplay.innerHTML = `
                <div class="w-full p-4 md:p-6 ${stateClass} rounded-2xl shadow-xl transition-all duration-500 transform scale-100">
                    <p class="text-3xl md:text-4xl font-black mb-4 block text-cute-shadow">${title}</p>
                    ${mediaHtml}
                    <!-- bodyHtml å…§å®¹åŒ…å«ç¦®ç‰©åç¨±æ™‚ï¼Œæœƒå°‡ç²—é«”åŠ å¤§æ¨£å¼æ”¾åœ¨ bodyHtml å‚³å…¥çš„ P æ¨™ç±¤ä¸Š -->
                    <div class="leading-relaxed whitespace-pre-wrap">${bodyHtml}</div>
                </div>
            `;
            giftBoxVisual.classList.add('hidden-item');
            actionArea.innerHTML = '';
            // æ¸…ç©ºè‡¨æ™‚è¨Šæ¯ï¼Œè®“ä½çµ¦ quiz-form å…§çš„ feedback-message
            // ä½†ä¿ç•™éŸ³æ¨‚æ’­æ”¾æç¤º
            if (message.onclick === null) {
                 message.textContent = ''; 
            }
            loadingSpinner.classList.add('hidden-item');
        }

        /**
         * é¡¯ç¤ºå•ç­”ç•«é¢
         */
        function showQuiz(question) {
            const inputType = question.type === 'multi' ? 'checkbox' : 'radio';
            let optionsHtml = '';
            
            question.options.forEach((option, index) => {
                optionsHtml += `
                    <label class="quiz-option text-left text-gray-700">
                        <input type="${inputType}" name="quiz-option" value="${index}" class="form-${inputType} text-amber-500">
                        <span class="text-lg font-medium">${option.text}</span>
                    </label>
                `;
            });

            showContentCard(question.title, `
                <form id="quiz-form" class="mt-4 w-full">
                    ${optionsHtml}
                    <div id="quiz-feedback" class="hidden-item"></div>
                </form>
            `, null, 'bg-amber-100/80'); // èƒŒæ™¯æ”¹ç‚ºæ·ºç¥ç€è‰²

            // æ·»åŠ æäº¤æŒ‰éˆ•
            const submitBtn = document.createElement('button');
            submitBtn.className = 'piggy-button bg-amber-600 hover:bg-amber-700 text-white shadow-lg mt-4'; // æŒ‰éˆ•æ”¹ç‚ºç¥ç€è‰²
            submitBtn.textContent = 'ç¢ºå®šé€å‡º';
            submitBtn.onclick = () => handleQuizSubmit(question.state);
            actionArea.appendChild(submitBtn);
        }

        /**
         * é¡¯ç¤ºå•ç­”çš„å³æ™‚åé¥‹è¨Šæ¯ (ä¸æœƒè·³è½‰ç‹€æ…‹)
         */
        function showFeedbackMessage(text) {
            const feedbackDiv = document.getElementById('quiz-feedback');
            if (feedbackDiv) {
                feedbackDiv.innerHTML = `<p>${text}</p>`;
                feedbackDiv.classList.remove('hidden-item');
                feedbackDiv.classList.add('feedback-message');
                
                // 1.5 ç§’å¾Œéš±è—åé¥‹
                setTimeout(() => {
                    feedbackDiv.classList.add('hidden-item');
                    feedbackDiv.classList.remove('feedback-message');
                    feedbackDiv.innerHTML = '';
                }, 1500);
            }
        }


        /**
         * è™•ç†å•ç­”æäº¤
         */
        function handleQuizSubmit(questionState) {
            const questionIndex = questionState - 1;
            const question = questions[questionIndex];
            const form = document.getElementById('quiz-form');
            const selectedOptions = Array.from(form.querySelectorAll(`input[name="quiz-option"]:checked`));
            
            // æª¢æŸ¥æ˜¯å¦é¸å–
            if (selectedOptions.length === 0) {
                message.textContent = 'è«‹é¸æ“‡è‡³å°‘ä¸€å€‹é¸é …ï¼';
                return;
            }
            // æ¸…ç©ºè‡¨æ™‚è¨Šæ¯ (ä½†ä¿ç•™éŸ³æ¨‚æ’­æ”¾æç¤º)
            if (message.onclick === null) {
                 message.textContent = ''; 
            }

            if (question.type === 'single') {
                const selectedIndex = parseInt(selectedOptions[0].value);
                const selectedOption = question.options[selectedIndex];

                if (selectedOption.isCorrect) {
                    updateGame(question.successState);
                } else {
                    // é¡¯ç¤ºå³æ™‚åé¥‹
                    showFeedbackMessage(selectedOption.feedback || 'ç­”éŒ¯äº†ï¼è«‹å†è©¦ä¸€æ¬¡ã€‚');
                    // åœç•™åœ¨ç•¶å‰ç‹€æ…‹
                }
            } else if (question.type === 'multi') {
                // æª¢æŸ¥æ˜¯å¦æ‰€æœ‰é¸é …éƒ½è¢«é¸ä¸­
                const allOptionsCount = question.options.length;
                const allCorrectlySelected = selectedOptions.length === allOptionsCount;
                
                if (allCorrectlySelected) {
                    updateGame(question.successState);
                } else {
                    showFeedbackMessage(question.failureFeedback || 'è«‹ç¢ºä¿æ‰€æœ‰æ­£ç¢ºç­”æ¡ˆéƒ½å·²è¢«é¸å–ã€‚');
                    // åœç•™åœ¨ç•¶å‰ç‹€æ…‹
                }
            } else if (question.type === 'branching') {
                // è™•ç† Q9 å’Œ Q10 çš„ç‰¹æ®Šé‚è¼¯
                const selectedIndex = parseInt(selectedOptions[0].value);
                const selectedOption = question.options[selectedIndex];

                if (selectedOption.isCorrect) {
                    updateGame(question.successState);
                } else if (selectedOption.failureState) {
                    // è·³è½‰åˆ°ç¢ºèªç•«é¢
                    updateGame(selectedOption.failureState);
                } else {
                    // å³æ™‚åé¥‹ (å¦‚ Q9 é¸ IU)
                    showFeedbackMessage(selectedOption.feedback || 'è«‹å†æƒ³ä¸€æƒ³ã€‚');
                    // åœç•™åœ¨ç•¶å‰ç‹€æ…‹
                }
            }
        }

        /**
         * è™•ç†ç¢ºèªç•«é¢ (Q9/Q10 å¤±æ•—è·¯å¾‘) çš„æŒ‰éˆ•é»æ“Š
         * @param {number} optionIndex é»æ“Šçš„é¸é …ç´¢å¼• (0: æˆ‘æ„›, 1: æˆ‘ä¸æ„›)
         * @param {number} backToQState é»æ“Šã€Œå°æˆ‘ä¸æ„›ã€æ™‚è¦è·³å›çš„é¡Œç›®ç‹€æ…‹ (Q9æˆ–Q10)
         * @param {number} successState é»æ“Šã€Œé¨™ä½ çš„ æˆ‘æ„›ã€æ™‚è¦è·³å¾€çš„é¡Œç›®ç‹€æ…‹ (Q10)
         */
        function handleConfirmationSubmit(optionIndex, backToQState, successState) {
            if (optionIndex === 0) {
                // é¸é …ä¸€: é¨™ä½ çš„ æˆ‘æ„›å°è±¬æ‹‰ (è·³åˆ°ä¸‹ä¸€é¡Œ)
                updateGame(successState);
            } else if (optionIndex === 1) {
                // é¸é …äºŒ: å°æˆ‘ä¸æ„›å°è±¬ (è­¦å‘Šä¸¦è·³å› Q9/Q10)
                message.textContent = 'âš ï¸ è­¦å‘Šçª—å£ï¼šæˆ‘å†çµ¦ä½ ä¸€æ¬¡æ©Ÿæœƒï¼è«‹çœŸå¿ƒå›ç­”ã€‚';
                
                // æ¨¡æ“¬è­¦å‘Šå»¶é²å¾Œè·³è½‰
                setTimeout(() => {
                    updateGame(backToQState);
                }, 1500); 
            }
        }

        /**
         * é¡¯ç¤ºç¦®ç‰©ç›’ï¼Œæº–å‚™é»æ“Š (State 14)
         */
        function showGiftBoxPrep() {
            contentDisplay.innerHTML = '';
            // ç¢ºä¿ç¦®ç‰©ç›’é‡è¨­ä¸¦å¯è¦‹
            giftBoxVisual.classList.remove('hidden-item');
            // ã€è·¯å¾‘ä¿®æ­£ï¼šä½¿ç”¨æ­£ç¢ºçš„ assets-gift è³‡æ–™å¤¾è·¯å¾‘ã€‘
            giftBoxVisual.src = "./assets-gift/gift1.jpg"; 
            giftBoxVisual.style.animation = 'none';
            giftBoxVisual.style.transform = 'scale(1) rotate(0deg)';
            giftBoxVisual.style.opacity = '1';
            void giftBoxVisual.offsetWidth; 

            actionArea.innerHTML = '';
            message.textContent = 'å½ˆè·³å‡ºä¸€å€‹ç¦®ç‰©ç›’ï¼Œé»æ“Šå®ƒä¾†é–‹ç®±ï¼';
        }

        /**
         * è™•ç†æœ€çµ‚ç¦®ç‰©ç›’è¢«é»æ“Šå¾Œï¼Œè§¸ç™¼å¼·å…‰å‹•ç•«ä¸¦é€²å…¥æœ€çµ‚ç¦®ç‰©ç‹€æ…‹ (State 21)
         */
        function triggerFinalGlowAnimation() {
            actionArea.innerHTML = '';
            contentDisplay.innerHTML = '';
            message.textContent = 'âš¡ï¸ çµ‚æ¥µå¤§çç™¼å‡ºå¼·å…‰ï¼å³å°‡æ­æ›‰... âš¡ï¸';
            
            // ç¢ºä¿ giftBoxVisual å®Œå…¨é‡ç½®ä¸¦é¡¯ç¤º
            giftBoxVisual.classList.remove('hidden-item');
            // ã€è·¯å¾‘ä¿®æ­£ï¼šä½¿ç”¨æ­£ç¢ºçš„ assets-gift è³‡æ–™å¤¾è·¯å¾‘ã€‘
            giftBoxVisual.src = "./assets-gift/gift1.jpg"; 
            giftBoxVisual.style.animation = 'none';
            giftBoxVisual.style.transform = 'scale(1) rotate(0deg)';
            giftBoxVisual.style.opacity = '1';
            void giftBoxVisual.offsetWidth; 

            // 1. è®“æ•´å€‹å®¹å™¨ç™¼å‡ºå¼·å…‰ (5ç§’)
            const container = document.getElementById('game-container');
            container.style.animation = 'strongGlow 5s ease-in-out forwards';
            
            // ç¦®ç‰©ç›’ç™¼å…‰å¾Œæ¶ˆå¤± (æ¨¡æ“¬æ‰“é–‹)
            giftBoxVisual.style.animation = 'openAndGlow 0.5s forwards'; 

            loadingSpinner.classList.remove('hidden-item');
            
            setTimeout(() => {
                // 5ç§’å¾Œï¼šå¼·å…‰çµæŸï¼Œç§»é™¤å‹•ç•«ï¼Œé€²å…¥ 2ç§’ç©ºç™½
                container.style.animation = 'none'; // ç§»é™¤å¼·å…‰
                contentDisplay.innerHTML = ''; // æ¸…ç©ºå…§å®¹
                loadingSpinner.classList.add('hidden-item'); 
                // *** è®Šæ›´è¨Šæ¯å…§å®¹ ***
                message.textContent = 'æœ€å¤§çæ˜¯.......!!'; 
                
                // 2. 2ç§’ç©ºç™½å»¶é²
                setTimeout(() => {
                    message.textContent = ''; // æ¸…ç©ºå€’æ•¸è¨Šæ¯
                    updateGame(STATE.GIFT_FINAL); // é€²å…¥æœ€çµ‚ç¦®ç‰©ç‹€æ…‹ (State 21)
                }, 2000);
                
            }, 5000); // ç­‰å¾… 5 ç§’å¼·å…‰å‹•ç•«çµæŸ
        }

        /**
         * è™•ç†ç¦®ç‰©ç›’é»æ“Šäº‹ä»¶
         */
        function handleGiftClick() {
            if (gameState !== STATE.GIFT_PREP) return;

            // æª¢æŸ¥æ˜¯å¦ç‚ºæœ€çµ‚ç¦®ç‰© (ç´¢å¼• 6)
            if (currentGiftIndex === 6) {
                triggerFinalGlowAnimation();
                return;
            }

            message.textContent = 'ç¦®ç‰©æ­£åœ¨æ‰“é–‹ä¸­...';
            giftBoxVisual.style.cursor = 'default';
            
            // 1. å½ˆè·³å…©ä¸‹ (jiggle)
            giftBoxVisual.style.animation = 'jiggle 0.5s ease-in-out 2';

            setTimeout(() => {
                // 2. æ‰“é–‹ç™¼å…‰ (open and glow)
                giftBoxVisual.style.animation = 'openAndGlow 0.8s forwards';

                setTimeout(() => {
                    // 3. é€²å…¥ç•¶å‰ç¦®ç‰©ç‹€æ…‹ (æ ¹æ“š currentGiftIndex)
                    const targetGift = giftSequence[currentGiftIndex];
                    if (!targetGift) {
                         message.textContent = 'éŠæˆ²çµæŸï¼';
                         return;
                    }
                    
                    if (targetGift.isExplosion) {
                         // çˆ†ç‚¸æ˜¯ç‰¹æ®Šç‹€æ…‹ï¼Œé€²å…¥ STATE.GIFT_EXPLOSION (20)
                         updateGame(STATE.GIFT_EXPLOSION);
                    } else {
                        // ä¸€èˆ¬ç¦®ç‰©ç‹€æ…‹ (15, 16, 17, 18, 19)
                        updateGame(STATE.GIFT_REVEAL_START + currentGiftIndex); 
                    }
                    giftBoxVisual.style.cursor = 'pointer';
                }, 800);
            }, 1000); 
        }

        /**
         * è™•ç†é–‹ç®±å¾Œçš„ä¸‹ä¸€æ­¥æŒ‰éˆ• (æ”¾/å†é–‹ä¸€å€‹ç¦®ç‰©ç›’)
         */
        function handleNextGiftStep(nextState) {
             // åªæœ‰åœ¨ Gift ç‹€æ…‹ (15-21) æ‰èƒ½ä½¿ç”¨
            if (gameState >= STATE.GIFT_REVEAL_START && gameState <= STATE.GIFT_FINAL) {
                
                if (nextState === STATE.GIFT_PREP) {
                    currentGiftIndex++; // ç§»å‹•åˆ°ä¸‹ä¸€å€‹ç¦®ç‰©
                    // ç¹¼çºŒé–‹ç®±: å›åˆ°ç¦®ç‰©ç›’ç­‰å¾…é»æ“Šç‹€æ…‹ (State 14)
                    updateGame(STATE.GIFT_PREP); 
                } else if (nextState === STATE.CARD) {
                    // æœ€çµ‚å¡ç‰‡
                    updateGame(STATE.CARD);
                }
            }
        }

        /**
         * æ’­æ”¾å¡ç‰‡æ–‡å­—é€å­—æ•ˆæœ (å·²ç§»é™¤æ¨™é¡Œ)
         */
        function typeText(text) {
            // ç§»é™¤æ¨™é¡Œï¼Œä¸¦èª¿æ•´å®¹å™¨å°é½Šæ–¹å¼ç‚ºå·¦ä¸Šè§’
            contentDisplay.innerHTML = `
                <div class="w-full p-6 bg-amber-50/90 rounded-2xl shadow-xl border-4 border-amber-300 transition-all duration-500 transform scale-100 min-h-[300px] flex flex-col items-start text-left">
                    <p class="text-3xl font-black mb-4 block text-cute-shadow text-center w-full">å°è±¬çš„çœŸå¿ƒè©±</p>
                    <pre id="typewriter" class="typewriter-text text-xl font-extrabold text-amber-700 leading-relaxed max-w-full overflow-hidden w-full pt-2"></pre>
                </div>
            `;
            const typewriter = document.getElementById('typewriter');
            let i = 0;
            const speed = 75; // æ¯å€‹å­— 75ms (æ”¾æ…¢é€Ÿåº¦)

            function type() {
                if (i < text.length) {
                    // è™•ç†æ›è¡Œï¼Œpre æ¨™ç±¤æœƒä¿æŒæ ¼å¼
                    typewriter.textContent += text.charAt(i); 
                    i++;
                    setTimeout(type, speed);
                } else {
                    typewriter.style.borderRight = 'none';
                    message.textContent = 'å¡ç‰‡è®€å–å®Œç•¢... é‚„æœ‰æœ€å¾Œä¸€å€‹é©šå–œï¼';
                    message.classList.remove('text-red-500');
                    message.classList.add('text-amber-600', 'text-2xl');

                    // æ–°å¢æŒ‰éˆ•ï¼šè·³è½‰åˆ°ç…§ç‰‡è¼ªæ’­
                    const nextBtn = document.createElement('button');
                    nextBtn.className = 'piggy-button bg-pink-500 hover:bg-pink-600 text-white shadow-lg mt-4';
                    nextBtn.textContent = 'é€²å…¥æœ€å¾Œçš„é©šå–œ (è¼ªæ’­)';
                    nextBtn.onclick = () => updateGame(STATE.PHOTO_SLIDESHOW);
                    actionArea.appendChild(nextBtn);
                }
            }
            type();
        }

        /**
         * é¡¯ç¤ºä¸¦å•Ÿå‹•ç…§ç‰‡è¼ªæ’­
         */
        function showSlideshow() {
            slideshowIndex = 0; // å¾ç¬¬ä¸€å¼µé–‹å§‹
            
            showContentCard(
                "å°ˆå±¬å›æ†¶éŒ„ ğŸ’–",
                `<div id="slideshow-container" class="relative w-full flex justify-center items-center min-h-[300px]">
                    <img id="current-photo" src="" alt="åˆç…§" class="slideshow-img active">
                </div>`,
                null,
                'bg-pink-100/90' // è¼ªæ’­ç•«é¢ä½¿ç”¨ç²‰è‰²ç³»
            );
            
            // é€™è£¡ä¸å†æ’­æ”¾éŸ³æ¨‚ï¼Œå› ç‚ºéŸ³æ¨‚åœ¨é€²å…¥å‰å·²åœæ­¢ (æ»¿è¶³ä½¿ç”¨è€…éœ€æ±‚)
            // åœ–ç‰‡å·²è¨­ç½®è¼‰å…¥éŒ¯èª¤è™•ç†

            // é¡¯ç¤ºç¬¬ä¸€å¼µç…§ç‰‡
            updateSlideshowImage();

            // å•Ÿå‹•è‡ªå‹•è¼ªæ’­ (æ¯ 3 ç§’æ›ä¸€å¼µ)
            slideshowInterval = setInterval(() => {
                slideshowIndex = (slideshowIndex + 1) % slideshowPhotos.length;
                updateSlideshowImage();
            }, 3000);

            // è¨­ç½®æ‰‹å‹•æ§åˆ¶æŒ‰éˆ•
            actionArea.innerHTML = `
                <div class="flex space-x-4">
                    <button class="piggy-button bg-indigo-500 hover:bg-indigo-600 text-white shadow-lg" onclick="manualSlideshow(-1)">
                        ä¸Šä¸€å¼µ
                    </button>
                    <button class="piggy-button bg-indigo-500 hover:bg-indigo-600 text-white shadow-lg" onclick="manualSlideshow(1)">
                        ä¸‹ä¸€å¼µ
                    </button>
                </div>
            `;

             // è¨­ç½®ç…§ç‰‡ç·¨è™Ÿæç¤º
            const slideshowContainer = document.getElementById('slideshow-container');
            const counter = document.createElement('p');
            counter.id = 'photo-counter';
            counter.className = 'mt-4 text-gray-600 font-bold';
            slideshowContainer.insertAdjacentElement('afterend', counter);
        }
        
        /**
         * æ›´æ–°è¼ªæ’­åœ–ç‰‡å’Œç·¨è™Ÿ
         */
        function updateSlideshowImage() {
            const imgElement = document.getElementById('current-photo');
            const counterElement = document.getElementById('photo-counter');
            
            if (imgElement && slideshowPhotos.length > 0) {
                 // è¨­ç½®æ·¡å‡ºå‹•ç•«
                imgElement.classList.remove('active');

                setTimeout(() => {
                    // è¨­ç½®æ–°åœ–ç‰‡å’Œæ·¡å…¥å‹•ç•«
                    imgElement.src = slideshowPhotos[slideshowIndex];
                    // åœ–ç‰‡è¼‰å…¥éŒ¯èª¤è™•ç† (ç¢ºä¿åœ–ç‰‡è·¯å¾‘æ­£ç¢º)
                    imgElement.onerror = function() {
                        this.src = "https://placehold.co/600x400/FF0000/FFFFFF?text=ç…§ç‰‡è¼‰å…¥å¤±æ•—";
                    }
                    imgElement.classList.add('active');
                    
                    if (counterElement) {
                        counterElement.textContent = `ç¬¬ ${slideshowIndex + 1} / ${slideshowPhotos.length} å¼µ`;
                    }
                }, 500); // ç­‰å¾… 500ms æ·¡å‡º
            }
        }

        /**
         * æ‰‹å‹•åˆ‡æ›ç…§ç‰‡
         */
        function manualSlideshow(direction) {
            // æ¸…é™¤è‡ªå‹•è¼ªæ’­ï¼Œé¿å…å¹²æ“¾
            clearInterval(slideshowInterval); 

            slideshowIndex = (slideshowIndex + direction + slideshowPhotos.length) % slideshowPhotos.length;
            updateSlideshowImage();
            
            // é‡æ–°å•Ÿå‹•è‡ªå‹•è¼ªæ’­
            slideshowInterval = setInterval(() => {
                slideshowIndex = (slideshowIndex + 1) % slideshowPhotos.length;
                updateSlideshowImage();
            }, 3000);
        }

        // === éŠæˆ²é‚è¼¯æ§åˆ¶ä¸­å¿ƒ ===

        /**
         * æ›´æ–°éŠæˆ²ç•«é¢å’Œç‹€æ…‹
         * @param {number} newState ç›®æ¨™ç‹€æ…‹
         */
        function updateGame(newState) {
            gameState = newState;
            actionArea.innerHTML = '';
            
            // æª¢æŸ¥æ˜¯å¦æ‡‰è©²æ’­æ”¾éŸ³æ¨‚ (å¾é–‹å§‹åˆ°å¡ç‰‡çµæŸ)
            if (newState <= STATE.CARD) {
                playMusic();
            } else if (newState === STATE.PHOTO_SLIDESHOW) {
                // é€²å…¥è¼ªæ’­å‰ï¼Œåœæ­¢èƒŒæ™¯éŸ³æ¨‚
                stopMusic();
            }
            
            // æ¸…é™¤ä¸€èˆ¬è¨Šæ¯ (ä½†ä¿ç•™éŸ³æ¨‚æ’­æ”¾æç¤º)
            if (message.onclick === null) {
                 message.textContent = ''; 
            }

            switch (gameState) {
                // --- æ¸¬é©—éšæ®µ (ä¿æŒä¸è®Š) ---
                case STATE.INTRO:
                    // åˆå§‹ä»‹ç´¹
                    const introHtml = `
                        <p class="text-4xl font-black mb-2 text-cute-shadow">æ­¡è¿ä¾†åˆ°2025</p>
                        <p class="text-3xl font-bold mb-4 text-cute-shadow">è±¬è±¬æœƒç¤¾å¹´æœ«æœ‰çå¾µç­”</p>
                        <p class="text-xl font-medium text-blue-600 font-extrabold">ç­”å°å…¨éƒ¨å°±å¯ä»¥ç²å¾—ç²¾ç¾å¤§çå–”ï¼</p>
                    `;

                    showContentCard(
                        "", // æ¨™é¡Œç•™ç©º
                        introHtml, // ä½¿ç”¨ HTML çµæ§‹
                        null,
                        'bg-amber-100/80' // èƒŒæ™¯æ”¹ç‚ºæ·ºç¥ç€è‰²
                    );
                    const startBtn = document.createElement('button');
                    startBtn.className = 'piggy-button bg-amber-600 hover:bg-amber-700 text-white shadow-lg'; // æŒ‰éˆ•æ”¹ç‚ºç¥ç€è‰²
                    startBtn.textContent = 'é–‹å§‹ç­”é¡Œ';
                    startBtn.onclick = () => updateGame(STATE.QUIZ_START);
                    actionArea.appendChild(startBtn);
                    break;
                
                // Q1 åˆ° Q10 çš„é€šç”¨è™•ç†
                case 1:
                case 2:
                case 3:
                case 4:
                case 5:
                case 6:
                case 7:
                case 8:
                case 9:
                case 10:
                    showQuiz(questions[gameState - 1]);
                    break;

                // Q9/Q10 å¤±æ•—ç¢ºèªç•«é¢
                case STATE.CONFIRM_Q9:
                    showContentCard(
                        "ä½ çœŸçš„ä¸æ„›å°è±¬å—?",
                        "è«‹ç¢ºèªä½ çš„å¿ƒæ„ã€‚",
                        null,
                        'bg-red-100/80' 
                    );
                    const btn11_1 = document.createElement('button');
                    btn11_1.className = 'piggy-button bg-green-500 hover:bg-green-600 text-white shadow-lg mr-4';
                    btn11_1.textContent = 'é¨™ä½ çš„ æˆ‘æ„›å°è±¬æ‹‰';
                    btn11_1.onclick = () => handleConfirmationSubmit(0, STATE.QUIZ_START + 8, STATE.QUIZ_END); 
                    actionArea.appendChild(btn11_1);

                    const btn11_2 = document.createElement('button');
                    btn11_2.className = 'piggy-button bg-orange-800 hover:bg-orange-900 text-white shadow-lg'; 
                    btn11_2.textContent = 'å°æˆ‘ä¸æ„›å°è±¬';
                    btn11_2.onclick = () => handleConfirmationSubmit(1, STATE.QUIZ_START + 8, STATE.QUIZ_END); 
                    actionArea.appendChild(btn11_2);
                    break;

                case STATE.CONFIRM_Q10:
                    showContentCard(
                        "æ‰€ä»¥ä½ ä¸æ„›å°è±¬å—?",
                        "é€™æ˜¯æœ€å¾Œçš„æ©Ÿæœƒï¼Œå¥½å¥½æƒ³æƒ³ï¼",
                        null,
                        'bg-red-100/80' 
                    );
                    const btn12_1 = document.createElement('button');
                    btn12_1.className = 'piggy-button bg-green-500 hover:bg-green-600 text-white shadow-lg mr-4';
                    btn12_1.textContent = 'é¨™ä½ çš„ æˆ‘æ„›å°è±¬æ‹‰';
                    btn12_1.onclick = () => handleConfirmationSubmit(0, STATE.QUIZ_END, STATE.QUIZ_END); 
                    actionArea.appendChild(btn12_1);

                    const btn12_2 = document.createElement('button');
                    btn12_2.className = 'piggy-button bg-orange-800 hover:bg-orange-900 text-white shadow-lg'; 
                    btn12_2.textContent = 'å°æˆ‘ä¸æ„›å°è±¬';
                    btn12_2.onclick = () => handleConfirmationSubmit(1, STATE.QUIZ_END, STATE.QUIZ_END); 
                    actionArea.appendChild(btn12_2);
                    break;
                
                // --- æ­å–œ/é€²å…¥é–‹ç®± (ä¿æŒä¸è®Š) ---
                case STATE.CONGRATS:
                    // ... (ä¿æŒä¸è®Š) ...
                    contentDisplay.innerHTML = `
                        <p class="text-4xl font-black text-amber-700 text-cute-shadow mb-4 animate-bounce">ğŸ‰ æ­å–œä½ ç²å¾—å¤§è±¬å°ˆå±¬ 2025 ç”Ÿæ—¥ç¦®ç‰©! ğŸ‰</p> 
                        <div id="intro-text" class="text-xl font-medium text-gray-700 leading-loose min-h-[100px] text-center"></div>
                    `;
                    
                    const lines = [
                        "å› ç‚ºé€™ä¸€å¹´ä¾†ä½ å°å°è±¬çš„ç…§é¡§é™ªä¼´ï¼Œ",
                        "è®“è±¬è±¬å…¬å¸ç‡Ÿé‹åˆ°ç¾åœ¨",
                        "ç‰¹åˆ¥ç‚ºä½ é ’ç™¼ç‰¹åˆ¥çé …",
                        "é‚£å°±è®“æˆ‘å€‘ä¸è¦å»¢è©±é‚£éº¼å¤š...",
                        "é–‹å§‹é–‹çå§~"
                    ];
                    let lineIndex = 0;
                    
                    function displayNextLine() {
                        if (lineIndex < lines.length) {
                            const p = document.createElement('p');
                            p.textContent = lines[lineIndex];
                            p.classList.add('opacity-0', 'transition-opacity', 'duration-1000', 'text-2xl', 'font-semibold');
                            document.getElementById('intro-text').appendChild(p);
                            setTimeout(() => { p.classList.remove('opacity-0'); }, 10); 
                            lineIndex++;
                            setTimeout(displayNextLine, 1500); 
                        } else {
                            setTimeout(() => {
                                const nextBtn = document.createElement('button');
                                nextBtn.className = 'piggy-button bg-amber-600 hover:bg-amber-700 text-white shadow-lg mt-8'; 
                                nextBtn.textContent = 'æº–å‚™å¥½äº†ï¼';
                                nextBtn.onclick = () => updateGame(STATE.GIFT_PREP);
                                actionArea.appendChild(nextBtn);
                            }, 1000);
                        }
                    }
                    displayNextLine();
                    break;

                // --- é–‹ç®±éšæ®µ (ä¿æŒä¸è®Š) ---
                case STATE.GIFT_PREP:
                    showGiftBoxPrep();
                    break;

                case 15: 
                case 16: 
                case 17: 
                case 18: 
                case 19: { 
                    const giftData = giftSequence[gameState - STATE.GIFT_REVEAL_START]; 
                    
                    const formattedGiftText = `<p class="text-2xl md:text-3xl font-extrabold text-cute-shadow whitespace-pre-wrap">${giftData.text}</p>`;

                    showContentCard(
                        giftData.title,
                        formattedGiftText, 
                        giftData.img,
                        'bg-amber-100/80' 
                    );
                    
                    const nextBtn = document.createElement('button');
                    nextBtn.className = 'piggy-button bg-amber-600 hover:bg-amber-700 text-white shadow-lg mt-4'; 
                    nextBtn.textContent = giftData.nextBtnText;
                    nextBtn.onclick = () => handleNextGiftStep(giftData.nextState); 
                    actionArea.appendChild(nextBtn);
                    break;
                }
                
                case STATE.GIFT_EXPLOSION: {
                    const giftData = giftSequence.find(g => g.isExplosion); 
                    message.textContent = 'ğŸ’¥ çˆ†ç‚¸! ğŸ’¥';
                    
                    giftBoxVisual.style.animation = 'explosion 0.5s forwards';
                    giftBoxVisual.classList.add('hidden-item'); 

                    showContentCard(
                        giftData.title,
                        giftData.text, 
                        giftData.img,
                        'bg-red-100/80'
                    );

                    setTimeout(() => {
                        const retryBtn = document.createElement('button');
                        retryBtn.className = 'piggy-button bg-amber-600 hover:bg-amber-700 text-white shadow-lg mt-4'; 
                        retryBtn.textContent = giftData.nextBtnText;
                        
                        retryBtn.onclick = () => {
                            currentGiftIndex = 6; 
                            updateGame(STATE.GIFT_PREP);
                        }; 
                        actionArea.appendChild(retryBtn);
                        
                        giftBoxVisual.style.animation = 'none';
                        giftBoxVisual.style.opacity = '1';
                        giftBoxVisual.style.transform = 'scale(1) rotate(0deg)'; 

                    }, 500); 
                    break;
                }
                
                case STATE.GIFT_FINAL: {
                    loadingSpinner.classList.add('hidden-item');
                    const finalGift = giftSequence[6]; 
                    
                    const formattedFinalText = `<p class="text-2xl md:text-3xl font-extrabold text-cute-shadow whitespace-pre-wrap">${finalGift.text}</p>`;
                    
                    showContentCard(
                        finalGift.title,
                        formattedFinalText, 
                        finalGift.img,
                        'bg-amber-100/90 border-4 border-amber-400' 
                    );

                    const finalBtn = document.createElement('button');
                    finalBtn.className = 'piggy-button bg-amber-400 hover:bg-amber-500 text-indigo-900 shadow-lg animate-pulse mt-4'; 
                    finalBtn.textContent = finalGift.nextBtnText;
                    finalBtn.onclick = () => handleNextGiftStep(finalGift.nextState); 
                    actionArea.appendChild(finalBtn);
                    break;
                }
                
                // --- æœ€çµ‚å¡ç‰‡ ---
                case STATE.CARD:
                    // å¡ç‰‡é€å­—æ’­æ”¾
                    typeText(cardText);
                    break;

                // --- ç…§ç‰‡è¼ªæ’­ ---
                case STATE.PHOTO_SLIDESHOW:
                    // éŸ³æ¨‚å·²åœ¨ updateGame å‡½æ•¸é–‹å§‹æ™‚åœæ­¢
                    showSlideshow();
                    break;

                default:
                    showContentCard('éŠæˆ²ç‹€æ…‹éŒ¯èª¤ï¼Œè«‹é‡æ–°æ•´ç†ã€‚', 'è«‹å¾é ­é–‹å§‹ã€‚', null, 'bg-red-100/80');
                    break;
            }
        }
        
        // é é¢è¼‰å…¥æ™‚å•Ÿå‹•éŠæˆ²ï¼Œä¸¦å˜—è©¦æ’­æ”¾éŸ³æ¨‚
        window.onload = () => updateGame(STATE.INTRO);
        
    </script>
</body>
</html>